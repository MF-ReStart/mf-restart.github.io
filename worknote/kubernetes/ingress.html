
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <title>Ingress · 荒原饮露的笔记</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.1.6">
        <meta name="author" content="荒原饮露">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="storage.html" />
    
    
    <link rel="prev" href="service-resources.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">简介</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                        <b>1.1.</b>
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Kubernetes</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                        <b>2.1.</b>
                    
                    Kubernetes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="overview.html">
            
                <a href="overview.html">
            
                    
                        <b>2.1.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="deployment-kubernetes-cluster.html">
            
                <a href="deployment-kubernetes-cluster.html">
            
                    
                        <b>2.1.2.</b>
                    
                    部署Kubernetes集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="kubelet-overview.html">
            
                <a href="kubelet-overview.html">
            
                    
                        <b>2.1.3.</b>
                    
                    Kubelet概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="object-resource-format.html">
            
                <a href="object-resource-format.html">
            
                    
                        <b>2.1.4.</b>
                    
                    对象类资源格式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="workload-resources.html">
            
                <a href="workload-resources.html">
            
                    
                        <b>2.1.5.</b>
                    
                    工作负载资源使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="service-resources.html">
            
                <a href="service-resources.html">
            
                    
                        <b>2.1.6.</b>
                    
                    Service资源
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.7" data-path="ingress.html">
            
                <a href="ingress.html">
            
                    
                        <b>2.1.7.</b>
                    
                    Ingress
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="storage.html">
            
                <a href="storage.html">
            
                    
                        <b>2.1.8.</b>
                    
                    存储
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.9" data-path="configuration.html">
            
                <a href="configuration.html">
            
                    
                        <b>2.1.9.</b>
                    
                    配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.10" data-path="statefulset.html">
            
                <a href="statefulset.html">
            
                    
                        <b>2.1.10.</b>
                    
                    StatefulSet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.11" data-path="certification-authorization-access-control.html">
            
                <a href="certification-authorization-access-control.html">
            
                    
                        <b>2.1.11.</b>
                    
                    认证授权与准入控制
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Docker</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../docker/readme.html">
            
                <a href="../docker/readme.html">
            
                    
                        <b>3.1.</b>
                    
                    Docker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../docker/overview.html">
            
                <a href="../docker/overview.html">
            
                    
                        <b>3.1.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../docker/install.html">
            
                <a href="../docker/install.html">
            
                    
                        <b>3.1.2.</b>
                    
                    安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../docker/images-and-containers.html">
            
                <a href="../docker/images-and-containers.html">
            
                    
                        <b>3.1.3.</b>
                    
                    镜像和容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../docker/data-persistence.html">
            
                <a href="../docker/data-persistence.html">
            
                    
                        <b>3.1.4.</b>
                    
                    数据持久化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../docker/network.html">
            
                <a href="../docker/network.html">
            
                    
                        <b>3.1.5.</b>
                    
                    网络
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../docker/dockerfile.html">
            
                <a href="../docker/dockerfile.html">
            
                    
                        <b>3.1.6.</b>
                    
                    Dockerfile
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">MySql</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../mysql/readme.html">
            
                <a href="../mysql/readme.html">
            
                    
                        <b>4.1.</b>
                    
                    MySql
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../mysql/mysql-base.html">
            
                <a href="../mysql/mysql-base.html">
            
                    
                        <b>4.1.1.</b>
                    
                    基础
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">笔记</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../life/dream.html">
            
                <a href="../../life/dream.html">
            
                    
                        <b>5.1.</b>
                    
                    Dream
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            本书使用 HonKit 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Ingress</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="ingress">Ingress</h1>
<p>Ingress 是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</p>
<p>Ingress 可以提供负载均衡、SSL 终结和基于名称的虚拟托管。</p>
<h2 id="ingress-是什么？">Ingress 是什么？</h2>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#ingress-v1beta1-networking-k8s-io" target="_blank">Ingress</a> 公开了从集群外部到集群内<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" target="_blank">服务</a>的 HTTP 和 HTTPS 路由。 流量路由由 Ingress 资源上定义的规则控制。</p>
<p>下面是一个将所有流量都发送到同一 Service 的简单 Ingress 示例：</p>
<p><img src="https://img.imgdb.cn/item/607553c38322e6675cd7616b.jpg" alt=""></img></p>
<p>可以将 Ingress 配置为服务提供外部可访问的 URL、负载均衡流量、终止 SSL/TLS，以及提供基于名称的虚拟主机等能力。 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank">Ingress 控制器</a> 通常负责通过负载均衡器来实现 Ingress，尽管它也可以配置边缘路由器或其他前端来帮助处理流量。</p>
<p>Ingress 不会公开任意端口或协议。 将 HTTP 和 HTTPS 以外的服务公开到 Internet 时，通常使用 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport" target="_blank">Service.Type=NodePort</a> 或 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer" target="_blank">Service.Type=LoadBalancer</a> 类型的服务。</p>
<h2 id="环境准备">环境准备</h2>
<p>你必须具有 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank">Ingress 控制器</a> 才能满足 Ingress 的要求。 仅创建 Ingress 资源本身没有任何效果。</p>
<p>你可能需要部署 Ingress 控制器，例如 <a href="https://kubernetes.github.io/ingress-nginx/deploy/" target="_blank">ingress-nginx</a>。 你可以从许多 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank">Ingress 控制器</a> 中进行选择。</p>
<p>理想情况下，所有 Ingress 控制器都应符合参考规范。但实际上，不同的 Ingress 控制器操作略有不同。</p>
<h2 id="ingress-资源">Ingress 资源</h2>
<p>一个最小的 Ingress 资源示例：</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">minimal-ingress</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/testpath</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">test</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<p>与所有其他 Kubernetes 资源一样，Ingress 需要使用 <code>apiVersion</code>、<code>kind</code> 和 <code>metadata</code> 字段。 Ingress 对象的命名必须是合法的 <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank">DNS 子域名名称</a>。 有关使用配置文件的一般信息，请参见<a href="https://kubernetes.io/zh/docs/tasks/run-application/run-stateless-application-deployment/" target="_blank">部署应用</a>、 <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/" target="_blank">配置容器</a>、 <a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/manage-deployment/" target="_blank">管理资源</a>。 Ingress 经常使用注解（annotations）来配置一些选项，具体取决于 Ingress 控制器，例如 <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/rewrite/README.md" target="_blank">重写目标注解</a>。 不同的 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank">Ingress 控制器</a> 支持不同的注解。查看文档以供你选择 Ingress 控制器，以了解支持哪些注解。</p>
<p>Ingress <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank">规约</a> 提供了配置负载均衡器或者代理服务器所需的所有信息。 最重要的是，其中包含与所有传入请求匹配的规则列表。 Ingress 资源仅支持用于转发 HTTP 流量的规则。</p>
<h3 id="ingress-规则">Ingress 规则</h3>
<p>每个 HTTP 规则都包含以下信息：</p>
<ul>
<li>可选的 <code>host</code>。在此示例中，未指定 <code>host</code>，因此该规则适用于通过指定 IP 地址的所有入站 HTTP 通信。 如果提供了 <code>host</code>（例如 foo.bar.com），则 <code>rules</code> 适用于该 <code>host</code>。</li>
<li>路径列表 paths（例如，<code>/testpath</code>）,每个路径都有一个由 <code>serviceName</code> 和 <code>servicePort</code> 定义的关联后端。 在负载均衡器将流量定向到引用的服务之前，主机和路径都必须匹配传入请求的内容。</li>
<li><code>backend</code>（后端）是 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" target="_blank">Service 文档</a> 中所述的服务和端口名称的组合。 与规则的 <code>host</code> 和 <code>path</code> 匹配的对 Ingress 的 HTTP（和 HTTPS ）请求将发送到列出的 <code>backend</code>。</li>
</ul>
<p>通常在 Ingress 控制器中会配置 <code>defaultBackend</code>（默认后端），以服务于任何不符合规约中 <code>path</code> 的请求。</p>
<h3 id="defaultbackend">DefaultBackend</h3>
<p>没有 <code>rules</code> 的 Ingress 将所有流量发送到同一个默认后端。 <code>defaultBackend</code> 通常是 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank">Ingress 控制器</a> 的配置选项，而非在 Ingress 资源中指定。</p>
<p>如果 <code>hosts</code> 或 <code>paths</code> 都没有与 Ingress 对象中的 HTTP 请求匹配，则流量将路由到默认后端。</p>
<h3 id="资源后端">资源后端</h3>
<p>Resource 后端是一个 ObjectRef，指向同一命名空间中的另一个 Kubernetes，将其作为 Ingress 对象。Resource 与 Service 配置是互斥的，在二者均被设置时会无法通过合法性检查。Resource 后端的一种常见用法是将所有入站数据导向带有静态资产的对象存储后端。</p>
<h3 id="路径类型">路径类型</h3>
<p>Ingress 中的每个路径都需要有对应的路径类型（Path Type）。未明确设置 <code>pathType</code> 的路径无法通过合法性检查。当前支持的路径类型有三种：</p>
<ul>
<li><code>ImplementationSpecific</code>: 对于这种路径类型，匹配方法取决于 IngressClass。 具体实现可以将其作为单独的 <code>pathType</code> 处理或者与 <code>Prefix</code> 或 <code>Exact</code> 类型作相同处理。</li>
<li><code>Exact</code>: 精确匹配 URL 路径，且区分大小写。</li>
<li><code>Prefix</code>: 基于以 <code>/</code> 分隔的 URL 路径前缀匹配。匹配区分大小写，并且对路径中的元素逐个完成。 路径元素指的是由 <code>/</code> 分隔符分隔的路径中的标签列表。 如果每个 <em>p</em> 都是请求路径 <em>p</em> 的元素前缀，则请求与路径 <em>p</em> 匹配。</li>
</ul>
<p><strong>说明：</strong> 如果路径的最后一个元素是请求路径中最后一个元素的子字符串，则不会匹配 （例如：<code>/foo/bar</code> 匹配 <code>/foo/bar/baz</code>, 但不匹配 <code>/foo/barbaz</code>）。</p>
<h3 id="示例">示例</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>路径</th>
<th>请求路径</th>
<th>匹配与否？</th>
</tr>
</thead>
<tbody>
<tr>
<td>Prefix</td>
<td><code>/</code></td>
<td>（所有路径）</td>
<td>是</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/foo</code></td>
<td>是</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/bar</code></td>
<td>否</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo</code></td>
<td><code>/foo/</code></td>
<td>否</td>
</tr>
<tr>
<td>Exact</td>
<td><code>/foo/</code></td>
<td><code>/foo</code></td>
<td>否</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/foo</code></td>
<td><code>/foo</code>, <code>/foo/</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/foo/</code></td>
<td><code>/foo</code>, <code>/foo/</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bb</code></td>
<td><code>/aaa/bbb</code></td>
<td>否</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb</code></td>
<td>是</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb/</code></td>
<td><code>/aaa/bbb</code></td>
<td>是，忽略尾部斜线</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb/</code></td>
<td>是，匹配尾部斜线</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbb/ccc</code></td>
<td>是，匹配子路径</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa/bbb</code></td>
<td><code>/aaa/bbbxyz</code></td>
<td>否，字符串前缀不匹配</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code></td>
<td><code>/aaa/ccc</code></td>
<td>是，匹配 <code>/aaa</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td>
<td><code>/aaa/bbb</code></td>
<td>是，匹配 <code>/aaa/bbb</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/</code>, <code>/aaa</code>, <code>/aaa/bbb</code></td>
<td><code>/ccc</code></td>
<td>是，匹配 <code>/</code> 前缀</td>
</tr>
<tr>
<td>Prefix</td>
<td><code>/aaa</code></td>
<td><code>/ccc</code></td>
<td>否，使用默认后端</td>
</tr>
<tr>
<td>混合</td>
<td><code>/foo</code> (Prefix), <code>/foo</code> (Exact)</td>
<td><code>/foo</code></td>
<td>是，优选 Exact 类型</td>
</tr>
</tbody>
</table>
<h3 id="最基本的-ingress-资源">最基本的 Ingress 资源</h3>
<p>注意：在此示例中，未指定 <code>host</code>，因此该规则适用于通过指定 IP 地址的所有入站 HTTP 通信。 如果提供了 <code>host</code>（例如 foo.bar.com），则 <code>rules</code> 适用于该 <code>host</code>。</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-wildcard-host</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/nginx"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
  <span class="hljs-attr">defaultBackend:</span>
    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">default-http-backend</span>
      <span class="hljs-attr">port:</span>
        <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<h3 id="基于-url-路由代理服务">基于 URL 路由代理服务</h3>
<p>配置根据请求的 HTTP URI 将来自同一 IP 地址的流量路由到多个 Service。</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-wildcard-host</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">"www.ingress.com"</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/nginx"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/tomcat"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
  <span class="hljs-attr">defaultBackend:</span> <span class="hljs-comment"># 如果hosts或paths都没有与Ingress对象中的HTTP请求匹配,则流量将路由到默认后端</span>
    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">default-http-backend</span>
      <span class="hljs-attr">port:</span>
        <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<h3 id="基于名称的虚拟托管">基于名称的虚拟托管</h3>
<p>基于名称的虚拟主机支持将针对多个主机名的 HTTP 流量路由到同一 IP 地址上。</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-wildcard-host</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">"www.nginx.com"</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">"www.tomcat.com"</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
  <span class="hljs-attr">defaultBackend:</span>
    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">default-http-backend</span>
      <span class="hljs-attr">port:</span>
        <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<h3 id="tls">TLS</h3>
<p>可以通过设定包含 TLS 私钥和证书的 <a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/" target="_blank">Secret</a> 来保护 Ingress。 Ingress 只支持单个 TLS 端口 443，并假定 TLS 连接终止于 Ingress 节点 （与 Service 及其 Pod 之间的流量都以明文传输）。 如果 Ingress 中的 TLS 配置部分指定了不同的主机，那么它们将根据通过 SNI TLS 扩展指定的主机名 （如果 Ingress 控制器支持 SNI）在同一端口上进行复用。 TLS Secret 必须包含名为 <code>tls.crt</code> 和 <code>tls.key</code> 的键名。 这些数据包含用于 TLS 的证书和私钥。例如：</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">testsecret-tls</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">tls.crt:</span> <span class="hljs-string">base64</span> <span class="hljs-string">编码的</span> <span class="hljs-string">cert</span>
  <span class="hljs-attr">tls.key:</span> <span class="hljs-string">base64</span> <span class="hljs-string">编码的</span> <span class="hljs-string">key</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/tls</span>
</code></pre>
<p>在 Ingress 中引用此 Secret 将会告诉 Ingress 控制器使用 TLS 加密从客户端到负载均衡器的通道。 你需要确保创建的 TLS Secret 创建自包含 <code>https-example.foo.com</code> 的公用名称（CN）的证书。 这里的公共名称也被称为全限定域名（FQDN）。</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-wildcard-host</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">tls:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">www.missf.top</span>
    <span class="hljs-attr">secretName:</span> <span class="hljs-string">www-missf-top</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">www.missf.top</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"/"</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
  <span class="hljs-attr">defaultBackend:</span>
    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">default-http-backend</span>
      <span class="hljs-attr">port:</span>
        <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<h4 id="生成-tls-自签证书">生成 tls 自签证书</h4>
<p>CFSSL 是 CloudFlare 开源的一款 PKI/TLS 工具。 CFSSL 包含一个命令行工具和一个用于签名、验证并且捆绑 TLS 证书的 HTTP API 服务，使用 Go 语言编写。</p>
<p><strong>安裝 <code>CFSSL</code> 工具</strong></p>
<pre><code class="lang-bash">curl -s -L -o /usr/local/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
curl -s -L -o /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
curl -s -L -o /usr/local/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
<span class="hljs-built_in">chmod</span> +x /usr/local/bin/cfssl*
</code></pre>
<p><strong>生成配置证书生成策略文件</strong></p>
<pre><code class="lang-json">cat &gt; ca-config.<span class="hljs-property">json</span> &lt;&lt;<span class="hljs-variable constant_">EOF</span>
{
  <span class="hljs-string">"signing"</span>: {
    <span class="hljs-string">"default"</span>: {
      <span class="hljs-string">"expiry"</span>: <span class="hljs-string">"87600h"</span>
    },
    <span class="hljs-string">"profiles"</span>: {
      <span class="hljs-string">"kubernetes"</span>: {
         <span class="hljs-string">"expiry"</span>: <span class="hljs-string">"87600h"</span>,
         <span class="hljs-string">"usages"</span>: [
            <span class="hljs-string">"signing"</span>,
            <span class="hljs-string">"key encipherment"</span>,
            <span class="hljs-string">"server auth"</span>,
            <span class="hljs-string">"client auth"</span>
        ]
      }
    }
  }
}
<span class="hljs-variable constant_">EOF</span>
</code></pre>
<p>这个策略，有一个默认的配置和一个 <code>profile</code>，这里的 <code>profile</code> 是 kubernetes。</p>
<p>signing: 表示该证书可用于签名其它证书。</p>
<p>server auth: 表示 client 可以用该 CA 对 server 提供的证书进行验证。</p>
<p>client auth: 表示 server 可以用该 CA 对 client 提供的证书进行验证。</p>
<p>expiry: 表示证书的有效期。</p>
<p><strong>生成 CA 证书和私钥配置文件</strong></p>
<pre><code class="lang-json">cat &gt; ca-csr.<span class="hljs-property">json</span> &lt;&lt;<span class="hljs-variable constant_">EOF</span>
{
    <span class="hljs-string">"CN"</span>: <span class="hljs-string">"kubernetes"</span>,
    <span class="hljs-string">"key"</span>: {
        <span class="hljs-string">"algo"</span>: <span class="hljs-string">"rsa"</span>,
        <span class="hljs-string">"size"</span>: <span class="hljs-number">2048</span>
    },
    <span class="hljs-string">"names"</span>: [
        {
            <span class="hljs-string">"C"</span>: <span class="hljs-string">"CN"</span>,
            <span class="hljs-string">"ST"</span>: <span class="hljs-string">"GuangDong"</span>,
            <span class="hljs-string">"L"</span>: <span class="hljs-string">"ShenZhen"</span>,
            <span class="hljs-string">"O"</span>: <span class="hljs-string">"Kubernetes"</span>,
            <span class="hljs-string">"OU"</span>: <span class="hljs-string">"Devops"</span>
        }
    ]
}
<span class="hljs-variable constant_">EOF</span>
</code></pre>
<p>CN: Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)，浏览器使用该字段验证网站是否合法。</p>
<p>C: Country， 国家。</p>
<p>ST: State，州，省。</p>
<p>L: Locality，地区，城市。</p>
<p>O: Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)。</p>
<p>OU: Organization Unit Name，组织单位名称，公司部门。</p>
<p><strong>生成 CA 证书、CA 私钥、CSR 文件</strong></p>
<pre><code class="lang-bash">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -

<span class="hljs-comment"># 得到如下文件</span>
[root@k8s-master ~/kubernetes/ssl]$ ll
total 28
-rw-r--r-- 1 root root  294 Apr 17 15:46 ca-config.json
-rw-r--r-- 1 root root 1013 Apr 17 15:48 ca.csr
-rw-r--r-- 1 root root  274 Apr 17 15:47 ca-csr.json
-rw------- 1 root root 1679 Apr 17 15:48 ca-key.pem
-rw-r--r-- 1 root root 1387 Apr 17 15:48 ca.pem
</code></pre>
<p><strong>生成服务端的证书信息</strong></p>
<pre><code class="lang-json">cat &gt; www.<span class="hljs-property">missf</span>.<span class="hljs-property">top</span>-csr.<span class="hljs-property">json</span> &lt;&lt;<span class="hljs-variable constant_">EOF</span>
{
  <span class="hljs-string">"CN"</span>: <span class="hljs-string">"www.missf.top"</span>,
  <span class="hljs-string">"hosts"</span>: [],
  <span class="hljs-string">"key"</span>: {
    <span class="hljs-string">"algo"</span>: <span class="hljs-string">"rsa"</span>,
    <span class="hljs-string">"size"</span>: <span class="hljs-number">2048</span>
  },
  <span class="hljs-string">"names"</span>: [
    {
       <span class="hljs-string">"C"</span>: <span class="hljs-string">"CN"</span>,
       <span class="hljs-string">"ST"</span>: <span class="hljs-string">"GuangDong"</span>,
       <span class="hljs-string">"L"</span>: <span class="hljs-string">"ShenZhen"</span>,
       <span class="hljs-string">"O"</span>: <span class="hljs-string">"Kubernetes"</span>,
       <span class="hljs-string">"OU"</span>: <span class="hljs-string">"System"</span>
    }
  ]
}
<span class="hljs-variable constant_">EOF</span>
</code></pre>
<p><strong>使用 ca 证书签发证书</strong></p>
<pre><code class="lang-bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes www.missf.top-csr.json | cfssljson -bare www.missf.top
</code></pre>
<p><strong>使用证书创建 secret 资源</strong></p>
<pre><code class="lang-bash">kubectl create secret tls www-missf-top --cert=www.missf.top.pem --key=www.missf.top-key.pem
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="service-resources.html" class="navigation navigation-prev " aria-label="Previous page: Service资源">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="storage.html" class="navigation navigation-next " aria-label="Next page: 存储">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Ingress","level":"2.1.7","depth":2,"next":{"title":"存储","level":"2.1.8","depth":2,"path":"worknote/kubernetes/storage.md","ref":"worknote/kubernetes/storage.md","articles":[]},"previous":{"title":"Service资源","level":"2.1.6","depth":2,"path":"worknote/kubernetes/service-resources.md","ref":"worknote/kubernetes/service-resources.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","-sharing","search-plus","github","expandable-chapters"],"root":".","styles":{"website":"styles/website.css"},"pluginsConfig":{"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true},"github":{"url":"https://github.com/MF-ReStart/mf-restart.github.io"},"search-plus":{},"expandable-chapters":{},"highlight":{},"fontsettings":{"theme":"white","family":"sans","size":2}},"theme":"default","author":"荒原饮露","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"荒原饮露的笔记","language":"zh-hans","gitbook":"*","description":"记录工作和生活"},"file":{"path":"worknote/kubernetes/ingress.md","mtime":"2026-01-30T01:33:18.793Z","type":"markdown"},"gitbook":{"version":"6.1.6","time":"2026-01-30T02:42:25.515Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

